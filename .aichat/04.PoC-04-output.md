# Plan Prac â€“ PoC OPA Decision Log Pipeline

Rozumiem wymagania. PoniÅ¼ej przedstawiam szczegÃ³Å‚owy plan implementacji **PRZED** rozpoczÄ™ciem kodowania. ProszÄ™ o przejrzenie i akceptacjÄ™.

---

## ğŸ“‹ Struktura Projektu

```
kafka-codegen-lab/
â”œâ”€â”€ build.gradle.kts              # Gradle build script (Kotlin DSL)
â”œâ”€â”€ settings.gradle.kts           # Gradle settings
â”œâ”€â”€ gradle.properties             # Wersje dependencies
â”œâ”€â”€ gradlew, gradlew.bat         # Gradle wrapper
â”œâ”€â”€ README.md                     # Instrukcja uruchomienia
â”œâ”€â”€ docker-compose.yml            # Kafka + Zookeeper (lokalny dev)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ kotlin/
â”‚   â”‚   â”‚   â””â”€â”€ com/opa/decisionlog/
â”‚   â”‚   â”‚       â”œâ”€â”€ DecisionLogApplication.kt        # Main class
â”‚   â”‚   â”‚       â”œâ”€â”€ config/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ KafkaProducerConfig.kt       # Kafka producer config
â”‚   â”‚   â”‚       â”œâ”€â”€ controller/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ DecisionLogController.kt     # REST endpoint
â”‚   â”‚   â”‚       â”œâ”€â”€ service/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ DecisionLogPublisher.kt      # Kafka publishing logic
â”‚   â”‚   â”‚       â””â”€â”€ model/
â”‚   â”‚   â”‚           â””â”€â”€ PublishResult.kt             # Result wrapper (sealed class)
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.yml                      # Config (profile: local)
â”‚   â”‚       â””â”€â”€ logback-spring.xml                   # Logging config
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ kotlin/
â”‚           â””â”€â”€ com/opa/decisionlog/
â”‚               â”œâ”€â”€ controller/
â”‚               â”‚   â””â”€â”€ DecisionLogControllerTest.kt # WebTestClient test
â”‚               â””â”€â”€ service/
â”‚                   â””â”€â”€ DecisionLogPublisherTest.kt  # Mock producer test
```

---

## ğŸ—ï¸ Architektura (Warstwy)

### 1. **Controller Layer** (`DecisionLogController`)
- Przyjmuje `POST /decision-logs`
- Body jako `String` (surowy JSON) lub `JsonNode`
- Deleguje publikacjÄ™ do `DecisionLogPublisher`
- Zwraca:
  - `201 Created` â€“ sukces
  - `500 Internal Server Error` â€“ bÅ‚Ä…d Kafka

### 2. **Service Layer** (`DecisionLogPublisher`)
- Enkapsuluje logikÄ™ publikacji do Kafka
- UÅ¼ywa `KafkaTemplate<String, String>` z Spring Kafka
- ObsÅ‚uguje wyjÄ…tki i loguje bÅ‚Ä™dy
- Zwraca `PublishResult` (sealed class: Success | Failure)

### 3. **Configuration Layer** (`KafkaProducerConfig`)
- Bean `ProducerFactory<String, String>`
- Bean `KafkaTemplate<String, String>`
- Ustawienia:
  - `bootstrap.servers` z `application.yml`
  - `key.serializer`: StringSerializer
  - `value.serializer`: StringSerializer
  - `acks=all`, `retries=3` (basic reliability)

### 4. **Model Layer** (`PublishResult`)
- Sealed class Kotlin:
  ```kotlin
  sealed class PublishResult {
      object Success : PublishResult()
      data class Failure(val error: Throwable) : PublishResult()
  }
  ```

---

## ğŸ“¦ Klasy i Komponenty

| Klasa/Plik | OdpowiedzialnoÅ›Ä‡ |
|------------|------------------|
| `DecisionLogApplication.kt` | Spring Boot main class (`@SpringBootApplication`) |
| `DecisionLogController.kt` | REST controller (`@RestController`, `@PostMapping`) |
| `DecisionLogPublisher.kt` | Service (`@Service`) â€“ publish do Kafka |
| `KafkaProducerConfig.kt` | Config (`@Configuration`) â€“ beans dla KafkaTemplate |
| `PublishResult.kt` | Sealed class â€“ wynik publikacji |
| `application.yml` | Spring profiles (local), Kafka bootstrap servers, topic name |
| `docker-compose.yml` | Kafka + Zookeeper (Confluent Platform 7.x lub wurstmeister) |

---

## âš™ï¸ Konfiguracja (`application.yml`)

```yaml
spring:
  application:
    name: opa-decision-log-pipeline
  profiles:
    active: local

---
spring:
  config:
    activate:
      on-profile: local

kafka:
  bootstrap-servers: localhost:9092
  topic:
    decision-logs: decision-logs
  producer:
    acks: all
    retries: 3
    key-serializer: org.apache.kafka.common.serialization.StringSerializer
    value-serializer: org.apache.kafka.common.serialization.StringSerializer
```

---

## ğŸ§ª Plan TestÃ³w

### 1. **DecisionLogControllerTest** (integration test)
- UÅ¼ycie `@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)`
- `WebTestClient` do wywoÅ‚ania POST /decision-logs
- **Opcja A**: `@EmbeddedKafka` â€“ prawdziwy embedded broker
- **Opcja B**: Mock `DecisionLogPublisher`
- Sprawdzenie:
  - Happy path: zwraca 201
  - Error path: zwraca 500

### 2. **DecisionLogPublisherTest** (unit test)
- Mock `KafkaTemplate` za pomocÄ… Mockito/MockK
- Weryfikacja wywoÅ‚ania `send()` z odpowiednimi parametrami
- Test sukcesu i bÅ‚Ä™du (CompletableFuture failure)

**Minimalne pokrycie:** 1 test happy path + 1 test error handling.

---

## ğŸ³ Docker Compose (Kafka Setup)

UÅ¼yjemy oficjalnej dystrybucji **Confluent Platform** lub **wurstmeister/kafka**:

```yaml
version: '3.8'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
      - "9092:9092"
```

---

## ğŸ“ Dependencies (build.gradle.kts)

```kotlin
plugins {
    kotlin("jvm") version "2.0.20"
    kotlin("plugin.spring") version "2.0.20"
    id("org.springframework.boot") version "3.5.8"
    id("io.spring.dependency-management") version "1.1.7"
}

dependencies {
    // Spring Boot WebFlux
    implementation("org.springframework.boot:spring-boot-starter-webflux")
    
    // Spring Kafka
    implementation("org.springframework.kafka:spring-kafka")
    
    // Kotlin
    implementation("org.jetbrains.kotlin:kotlin-reflect")
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-reactor")
    
    // Jackson
    implementation("com.fasterxml.jackson.module:jackson-module-kotlin")
    
    // Test
    testImplementation("org.springframework.boot:spring-boot-starter-test")
    testImplementation("org.springframework.kafka:spring-kafka-test")
    testImplementation("io.projectreactor:reactor-test")
}
```

---

## ğŸš€ Instrukcja Uruchomienia (README.md)

1. **Uruchom Kafka:**
   ```bash
   docker-compose up -d
   ```

2. **Zbuduj projekt:**
   ```bash
   ./gradlew clean build
   ```

3. **Uruchom aplikacjÄ™:**
   ```bash
   ./gradlew bootRun
   ```

4. **Test endpoint:**
   ```bash
   curl -X POST http://localhost:8080/decision-logs \
     -H "Content-Type: application/json" \
     -d '[{"decision": "allow", "user": "alice"}]'
   ```

5. **SprawdÅº wiadomoÅ›Ä‡ w Kafka:**
   ```bash
   docker exec -it kafka-codegen-lab-kafka-1 \
     kafka-console-consumer --bootstrap-server localhost:9092 \
     --topic decision-logs --from-beginning
   ```

---

## âœ… Kryteria Akceptacji

- [ ] Projekt buduje siÄ™: `./gradlew clean build`
- [ ] Endpoint POST /decision-logs zwraca 201 przy sukcesie
- [ ] Payload trafia do Kafka topic `decision-logs`
- [ ] BÅ‚Ä…d Kafka zwraca 500
- [ ] Przynajmniej 1 test integracyjny przechodzi
- [ ] README zawiera instrukcjÄ™ uruchomienia

---

## â±ï¸ Szacowany Czas Implementacji

- Setup projektu + Gradle: 15 min
- Implementacja klas: 30 min
- Konfiguracja Kafka: 15 min
- Testy: 20 min
- Docker Compose + README: 10 min
- **TOTAL: ~1.5h**

---

## â“ Pytania/Uwagi przed implementacjÄ…

1. **Czy uÅ¼ywaÄ‡ Spring Kafka tradycyjnego czy reactive (`spring-kafka` + `reactor-kafka`)?**  
   â†’ ProponujÄ™ tradycyjny `KafkaTemplate` dla prostoty PoC (wystarczy do weryfikacji).

2. **Czy endpoint ma byÄ‡ reactive (`Mono<ResponseEntity>`) czy imperatywny?**  
   â†’ ProponujÄ™ reactive dla zgodnoÅ›ci z WebFlux.

3. **Czy klucz wiadomoÅ›ci Kafka ma byÄ‡ statyczny (np. "opa-decision") czy np. UUID dla kaÅ¼dego batcha?**  
   â†’ ProponujÄ™ statyczny String dla prostoty.

---

**ğŸ›‘ CZEKAM NA TWOJÄ„ AKCEPTACJÄ˜ PRZED ROZPOCZÄ˜CIEM KODOWANIA.**

JeÅ›li coÅ› w planie wymaga zmiany, daj znaÄ‡!