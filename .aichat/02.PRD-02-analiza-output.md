1. Cel i problem do rozwiązania
- Zapewnienie trwałego (S3, 20 lat) i niemal-natychmiastowego (OpenSearch, ≤ 1 min) dostępu do logów decyzji autoryzacyjnych emitowanych przez setki instancji OPA działających jako sidecar w klastrze Kubernetes.
- Ograniczenie ryzyka utraty logów i uproszczenie analizy operacyjnej.
2. Zakres MVP – funkcje kluczowe
   a. HTTP-ingress przyjmujący batche decision-logów (JSON array, ≤ 1 MB) z OPA zabezpieczony API Key (możliwość wielu kluczy).
   b. Publikacja batchy do Apache Kafka (klucz partycji dowolny, surowe JSON array).
   c. Konsument Kafka → S3:
    - Bundling plików z decyzjami; format gzip; rollover czasowy/rozmiarowy do ustalenia, rekomendacja ≤ 128 MB.
    - Ścieżka: s3://<bucket>/<environment>/<product>/… bez wersjonowania prefixu.
    - Retencja danych: 20 lat; polityka lifecycle do Glacier po ustalonym czasie.
      d. Konsument Kafka → OpenSearch: indexowanie decyzji; retencja 3 dni; automatyczne usunięcie po tym czasie (ILM).
      e. DLQ dla błędów zapisu do S3 lub OpenSearch; ręczna obsługa przez zespół projektu (dashboard/alert dostarczany przez platformę).
      f. SLA: decyzje dostępne w OpenSearch ≤ 60 s od wysłania przez OPA.
3. Wolumen i wydajność
- Średnio 15 000 decyzji/min; szczyt 50 000 min; miesięcznie do 200 M decyzji.
- Pojedyncza decyzja 2.5–3.5 kB; batch ~10 decyzji ≈ 30 kB.
- Maksymalny rozmiar rekordu Kafka: 1 MB (w razie przekroczenia – chunking po stronie producenta).
- Testy wydajności e2e wymagane dla scenariusza 50 k/min, weryfikujące SLA 1 min.
4. Bezpieczeństwo i dostęp
- Transmisja OPA → ingress zabezpieczona API Key (przechowywany w K8s Secret; możliwość rotacji/hot-reload).
- Brak dodatkowego szyfrowania danych w spoczynku (Kafka, S3, OpenSearch) na etapie MVP.
- Logi mogą zawierać dane wrażliwe; żadnej maski/pii-redaction w MVP.
5. Monitorowanie i alerting
- Metryki lag/throughput, DLQ size, age>1 min w OpenSearch dostarczane centralnie przez platformę.
- Zespół projektu odpowiada za on-call oraz ręczny re-process DLQ.
6. Ograniczenia / poza zakresem MVP
- Brak wyszukiwania/analityki w S3, back-fill historycznych logów, rozbudowanej obserwowalności, PII masking,
  self-service UI, GDPR delete-requests.
- Nie planuje się wersjonowania ścieżek w S3 ani globalnego porządku zdarzeń.
- Setup i utrzymanie klastra OpenSearch realizowane poza tym projektem.
7. Otwarte punkty do doprecyzowania (rekomendowane przed finalizacją PRD)
- Dokładna strategia bundlingu/rollover plików gzip (np. 5 min lub 128 MB).
- Polityka lifecycle w S3 (kiedy przejście do Glacier / Deep Archive).
- Procedura rotacji i awaryjnej wymiany wielu API Keys bez restartu OPA.
- Dokumentacja/SDK lub OpenAPI spec dla endpointu ingress (opcjonalnie).
- Plan testów wydajnościowych i kryteria akceptacji SLA 1 min.
