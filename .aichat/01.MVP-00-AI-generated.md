MVP – OPA Decision-Log Pipeline
(OPA → Kafka → OpenSearch + S3)
Poniższy dokument konsoliduje wszystkie uzgodnione sekcje: problem, zakres MVP, granice, user-flowy oraz kryteria sukcesu. Stanowi kompletny artefakt do kickoffu prac inżynierskich i akceptacji interesariuszy.
====================================================================
Identyfikacja kluczowego problemu
OPA (Open Policy Agent) działa jako sidecar przy setkach mikro-serwisów w Kubernetes.
Każda autoryzacja generuje decision log (~3 kB).
Wolumen:
średnio 15 000 logów/min (≈ 250 logów/s)
szczytowo 100 000 logów/min (≈ 1 667 logów/s)
Wymagania retencji i dostępu:
OpenSearch: 3 dni, czas odpowiedzi ≤ 2 s
AWS S3: 20 lat, brak wymagań wyszukiwania w MVP
Brak utraty logów jest nieakceptowalny (wymóg działu Legal).
Obecne, zewnętrzne rozwiązanie zostanie wyłączone.
Dostępne zasoby: Kafka, Kubernetes, OpenSearch, AWS S3, PostgreSQL.
====================================================================
Najkrótsza ścieżka do dostarczenia wartości (Scope MVP)
A. „Moment wartości”
SRE / Security-engineer wpisuje zapytanie w OpenSearch i w < 2 s otrzymuje log sprzed kilku minut, mając pewność, że jest też zarchiwizowany w S3.
B. Minimalne komponenty
OPA → Kafka (producer sidecar, acks=all, retry ∞)
Kafka consumer #1 → OpenSearch (bulk, ILM rollover 12 h, retencja 3 d)
Kafka consumer #2 → S3 (batch 1 min lub 100 MB, gzip JSON, SSE-S3)
Monitoring: Kafka lag, ingest error-rate, S3 retry; alerty → PagerDuty
Jeden dashboard i runbook dla użytkownika
C. Definition of Done (fragment)
≥ 99,99 % logów trafia do S3; ≥ 99,9 % do OpenSearch ≤ 60 s
Zapytania OS ≤ 2 s (95-ty percentyl)
Alerty przy Kafka lag > 60 s lub error-rate > 0,1 %
====================================================================
Granice projektu (Out-of-Scope)
Wyszukiwanie/analiza w S3 (Athena, Glue)
Back-fill historycznych logów
Zaawansowany RBAC i field-level security w OS
PII masking/redaction
Multi-region DR, cross-cluster search
Auto-tiering S3 (Standard → Glacier)
Rozbudowana obserwowalność (tracing, latency histograms)
Self-service UI, GDPR delete-requests, pełna integracja z SIEM
Skalowanie > 10× obecnego szczytowego TPS, active-active 99,99 % HA
====================================================================
Kluczowe ścieżki użytkownika (User Flows)
FLOW 1 – Ingest (OPA → Kafka)
OPA tworzy log 2. Producer wysyła do topicu 3. Kafka zapisuje (3 repliki)
FLOW 2 – Index (Kafka → OpenSearch)
Consumer pobiera batch 2. Bulk-insert do indeksu 3. Commit offset
FLOW 3 – Archive (Kafka → S3)
Consumer buforuje do 1 min 2. Upload gzip JSON 3. Commit offset
FLOW 4 – Query & Troubleshoot
SRE wyszukuje w OS, otrzymuje wynik ≤ 2 s; w razie braku logu sprawdza metryki.
FLOW 5 – Alert Handling
System wykrywa Kafka lag / ingest errors → PagerDuty → on-call przywraca zdrowie.
Każdy flow zawiera punkt „can’t-fail” (utrata logu lub commit przed zapisem).
====================================================================
Kryteria sukcesu (Measurement & Acceptance)
Outcome KPI
End-to-end delivery ≥ 99,99 % (OPA producer vs pliki S3)
95-ty percentyl czasu zapytań OS ≤ 2 s
99-ty percentyl Kafka→OS opóźnienia ≤ 60 s
99-ty percentyl Kafka→S3 opóźnienia ≤ 10 min
Leading metrics & alerty
Kafka lag < 60 s • ingest_error_rate < 0,1 % • S3 retry < 3/plik
DoD testy
10 000 logów e2e → ≥ 9 999 w S3, ≥ 9 990 w OS ≤ 60 s
Symulacja błędów OS generuje alert < 1 min, brak utraty logów
Runbook i dashboard publicznie dostępne
MVP uznaje się za ukończone, gdy wszystkie KPI utrzymują się 7 dni z rzędu i DoD przejdą pozytywnie.